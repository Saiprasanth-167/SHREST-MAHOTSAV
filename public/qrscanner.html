<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Scanner - SHREST</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin:0; background:linear-gradient(135deg,#f8ffae 0%,#43c6ac 50%,#191654 100%); min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .wrap { width:95%; max-width:700px; background:#fff; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.08); }
    h2 { margin:8px 0 16px; color:#1a2980; text-align:center; }
    #reader { width:100%; max-width:560px; margin:0 auto; }
    .details { margin-top:16px; background:#f9fbff; border:1px solid #eef2f7; border-radius:8px; padding:12px; }
    .row { margin:6px 0; }
    .label { font-weight:600; color:#34495e; width:140px; display:inline-block; }
    .val { color:#2c3e50; }
    .actions { display:flex; gap:10px; margin-top:12px; flex-wrap: wrap; }
    button { padding:10px 14px; border:none; border-radius:8px; color:#fff; font-weight:600; cursor:pointer; }
    .back { background:linear-gradient(90deg,#1a2980 0%,#26d0ce 100%); }
    .clear { background:linear-gradient(90deg,#f7971e 0%,#ffd200 100%); color:#fff; }
    .export { display:inline-block; text-decoration:none; padding:10px 14px; border-radius:8px; font-weight:600; color:#fff; background:linear-gradient(90deg,#43c6ac 0%, #1a2980 100%); }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="wrap">
    <h2>Scan Registration QR</h2>
    <div id="reader"></div>
    
    <div class="details" id="details" style="display:none;">
      <div class="row"><span class="label">Name:</span> <span class="val" id="d_name"></span></div>
      <div class="row"><span class="label">Reg No:</span> <span class="val" id="d_regno"></span></div>
      <div class="row"><span class="label">Mobile:</span> <span class="val" id="d_mobile"></span></div>
      <div class="row"><span class="label">Campus:</span> <span class="val" id="d_campus"></span></div>
      <div class="row"><span class="label">Year:</span> <span class="val" id="d_year"></span></div>
      <div class="row"><span class="label">UTR:</span> <span class="val" id="d_utr"></span></div>
      <div class="row"><span class="label">Amount:</span> <span class="val" id="d_amount"></span></div>
      <div class="row"><span class="label">Events:</span> <span class="val" id="d_events"></span></div>
      <div class="row"><span class="label">Timestamp:</span> <span class="val" id="d_ts"></span></div>
    </div>
    <div id="scan-status" style="text-align: center; margin-top: 16px; font-weight: 600;"></div>
    <div class="actions">
      <button class="back" onclick="window.location.href='home.html'">Back</button>
      <button class="clear" id="clearBtn">Clear</button>
      <a class="export" href="/live-excel" target="_blank">See Live Excel Sheet</a>
    </div>
  </div>
  <script>
    const details = document.getElementById('details');
    const scanStatus = document.getElementById('scan-status');
    const reader = new Html5Qrcode("reader");
  const config = { fps: 30, qrbox: { width: 300, height: 300 } };
    let scannedUtrs = new Set();

    function showData(obj) {
      document.getElementById('d_name').textContent = obj.name || '';
      document.getElementById('d_regno').textContent = obj.regno || '';
      document.getElementById('d_mobile').textContent = obj.mobile || '';
      document.getElementById('d_campus').textContent = obj.campus || '';
      document.getElementById('d_year').textContent = obj.year || '';
      document.getElementById('d_utr').textContent = obj.utr || '';
      document.getElementById('d_amount').textContent = (obj.amount != null ? obj.amount : '');
      
      let eventsDisplay = '';
      if (obj.events) {
        try {
          const eventsArray = JSON.parse(obj.events);
          eventsDisplay = eventsArray.join(', ');
        } catch {
          eventsDisplay = obj.events;
        }
      }
      document.getElementById('d_events').textContent = eventsDisplay;
      
      document.getElementById('d_ts').textContent = obj.timestamp || '';
      details.style.display = 'block';
    }

    function onScanSuccess(decodedText) {
      scanStatus.textContent = '';
      scanStatus.style.color = 'black';

      try {
        const obj = JSON.parse(decodedText);
        if (!obj.utr) {
          throw new Error("Invalid QR code: No UTR found.");
        }

        if (scannedUtrs.has(obj.utr)) {
          scanStatus.textContent = 'This QR is already scanned.';
          scanStatus.style.color = 'orange';
          details.style.display = 'none';
          return;
        }

        fetch('/api/registrations/' + encodeURIComponent(String(obj.utr)))
          .then(res => {
            if (res.status === 404) {
              scanStatus.textContent = 'QR IS INVALID';
              scanStatus.style.color = 'red';
              details.style.display = 'none';
              return null;
            }
            return res.json();
          })
          .then(data => {
            if (data && data.success && data.registration) {
              showData(data.registration);
              scannedUtrs.add(obj.utr);
              scanStatus.textContent = 'Scan successful!';
              scanStatus.style.color = 'green';
            }
          })
          .catch(() => {
            scanStatus.textContent = 'Error validating QR code.';
            scanStatus.style.color = 'red';
            details.style.display = 'none';
          });

      } catch (e) {
        scanStatus.textContent = 'This QR is invalid.';
        scanStatus.style.color = 'red';
        details.style.display = 'none';
      }
    }

    reader.start({ facingMode: "environment" }, config, onScanSuccess);

    document.getElementById('clearBtn').onclick = () => {
      details.style.display = 'none';
      scanStatus.textContent = '';
      ["d_name","d_regno","d_mobile","d_campus","d_year","d_utr","d_amount","d_events","d_ts"].forEach(id => document.getElementById(id).textContent = '');
    };

  </script>
</body>
</html>
