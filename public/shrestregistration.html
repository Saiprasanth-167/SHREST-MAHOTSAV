<!-- Tesseract.js for OCR -->
	<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SHREST MAHOTSAV Registration FORM</title>
	<style>
		body {
			font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
			background: linear-gradient(120deg, #9236e8 0%, #c2e9fb 100%);
			margin: 0;
			padding: 0;
			min-height: 100vh;
		}
		.container {
			max-width: 480px;
			margin: 48px auto;
			background: rgba(255,255,255,0.97);
			padding: 36px 38px 30px 38px;
			border-radius: 18px;
			box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
			position: relative;
			overflow: hidden;
		}
		h2 {
			text-align: center;
			color: whitesmoke;
			font-size: 2.1rem;
			margin-bottom: 28px;
			letter-spacing: 1px;
		}
		.form-group {
			margin-bottom: 22px;
		}
		label {
			display: block;
			margin-bottom: 7px;
			font-weight: 600;
			color: #1a2980;
			letter-spacing: 0.5px;
		}
		input, select {
			width: 100%;
			padding: 10px 12px;
			border: 1.5px solid #b2bec3;
			border-radius: 6px;
			font-size: 1rem;
			background: #f8fafc;
			transition: border 0.2s;
			margin-top: 2px;
		}
		input:focus, select:focus {
			border: 1.5px solid #2980b9;
			outline: none;
			background: #eaf6fb;
		}
		.hidden {
			display: none;
		}
		.error {
			color: #e74c3c;
			margin-bottom: 10px;
			font-size: 0.98rem;
			font-weight: 500;
		}
		.success {
			color: #27ae60;
			margin-bottom: 10px;
			font-size: 0.98rem;
			font-weight: 500;
		}
		button {
			background: linear-gradient(90deg, #1a2980 0%, #26d0ce 100%);
			color: #fff;
			border: none;
			padding: 11px 0;
			border-radius: 6px;
			cursor: pointer;
			font-size: 1.08rem;
			font-weight: 600;
			width: 100%;
			margin-top: 6px;
			box-shadow: 0 2px 8px #0001;
			transition: background 0.2s, box-shadow 0.2s;
		}
		button:disabled {
			background: #b2bec3;
			color: #fff;
			cursor: not-allowed;
		}
		#utr-section, #registration-form {
			animation: fadeIn 0.7s;
		}
		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(30px); }
			to { opacity: 1; transform: translateY(0); }
		}
		/* Custom file input */
		input[type="file"]::-webkit-file-upload-button {
			visibility: hidden;
		}
		input[type="file"]::before {
			content: 'Choose Screenshot';
			display: inline-block;
			background: #26d0ce;
			color: #fff;
			border: none;
			border-radius: 6px;
			padding: 8px 16px;
			outline: none;
			white-space: nowrap;
			-webkit-user-select: none;
			user-select: none;
			cursor: pointer;
			font-size: 1rem;
			font-weight: 500;
			margin-right: 10px;
		}
		input[type="file"]:focus::before {
			outline: 2px solid #2980b9;
		}
		/* Responsive */
		@media (max-width: 600px) {
			.container {
				padding: 18px 6vw 18px 6vw;
			}
			h2 {
				font-size: 1.4rem;
			}
		}

		/* Fee side widget (mirrors home.html) */
		.fee-side { width: 92%; max-width: 520px; background:#fff; border-radius:16px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,0.08); text-align:left; margin: 28px auto; }
		.fee-side h3 { margin:0 0 10px; color:#1a2980; font-size:1.1rem; }
		.fee-side label { display:block; margin-top:8px; margin-bottom:6px; color:#34495e; font-weight:600; }
		.fee-side select { width:100%; padding:10px; border:1.5px solid #b2bec3; border-radius:8px; font-size:1rem; background:#fff; }
		.fee-side input[type="text"] { width:100%; padding:10px; border:1.5px solid #b2bec3; border-radius:8px; font-size:1rem; background:#fff; }
		.fee-note { margin-top:8px; color:#7f8c8d; font-size:.9rem; }
		.fee { margin-top:12px; font-weight:700; color:#1a2980; font-size:1.05rem; }
		.fee-qr-block { margin-top:14px; padding:12px; border:1px solid #e6ecf2; border-radius:10px; background:#fafcff; }
		.fee-qr-title { font-weight:700; color:#34495e; margin-bottom:8px; }
		.fee-qr-img { width:100%; max-width:300px; display:block; margin:6px auto; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
		.fee-amount { margin-top:8px; font-weight:700; color:#1a2980; text-align:center; }
		.fee-qr-actions { display:flex; gap:10px; justify-content:center; margin-top:8px; flex-wrap:wrap; }
		.fee-qr-actions a, .fee-qr-actions button { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; color:#fff; text-decoration:none; background:linear-gradient(90deg,#1a2980 0%, #26d0ce 100%); }
		/* Top title container */
		.title-side { width: 100%; max-width: 600px;background: linear-gradient(120deg, #9236e8 50%, #66bbe3 50%); border-radius:14px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.08); text-align:center; margin: 28px auto 0; 
		}
	</style>
</head>
<body>
	<!-- Title above the fee panel -->
	<div class="title-side" id="titlePanel">
		<h2>SHREST MAHOTSAV 2K25 Registration FORM</h2>
	</div>
	<!-- Entry Fee by Year (shown on registration page) -->
	<div class="fee-side" id="feePanel">
		<h3>Entry Fee by Year</h3>
		<div class="mini-alert" role="alert">USE PHONEPAY ONLY TO PAY THE AMOUNT</div>
		<label for="feeCourseSelect">Course</label>
		<select id="feeCourseSelect">
			<option value="select">Select your course</option>
			<option value="B.Tech">B.Tech</option>
			<option value="DEGREE">DEGREE</option>
			<option value="Other">Other</option>
		</select>
		<div id="feeOtherCourseGroup" style="display:none; margin-top:6px;">
			<label for="feeCourseOther">Enter Course Name</label>
			<input id="feeCourseOther" type="text" placeholder="ENTER YOUR COURSE NAME" />
		</div>
		<div id="feeYearBlock" style="display:none;">
			<label for="feeYearSelect">Select Year</label>
			<select id="feeYearSelect">
				<option value="">Select your year</option>
				<option value="1">1st Year</option>
				<option value="2">2nd Year</option>
				<option value="3">3rd Year</option>
				<option value="4">4th Year</option>
			</select>
			<div class="fee" id="feeDisplayReg">Fee: -</div>
			<div class="fee-note">Note: 4th year fee (Rs 400) applies to B.Tech students only.</div>
			<div class="fee-qr-block">
				<div class="fee-qr-title">UPI Payment</div>
				<canvas id="upiQrCanvas" class="fee-qr-img"></canvas>
				<div class="fee-amount" id="feePhonepeAmount">Select course to see amount</div>
				<div class="fee-note" id="feeUpiNote" style="text-align:center;">Scan this QR in phonepe only ; amount auto-fills.</div>
				<div class="fee-note" id="feeUpiWarn" style="text-align:center;color:#b23c17;display:none;"></div>
				<div class="success" id="feePaymentSuccess" style="display:none; text-align:center; margin-top:8px;">Transaction is successful, proceed to next step.</div>
			</div>
		</div>
	</div>
	<div class="container">
		<!-- Mini contact container (below the card) -->
		<div id="miniContact"></div>
		<div id="utr-section">
			<div class="form-group">
				<label for="utr">PhonePe UTR Number (12 digits)</label>
				<input type="text" id="utr" maxlength="12" pattern="\d{12}" required>
			</div>
			<div class="form-group">
				<label for="screenshot">Upload Payment Screenshot</label>
				<input type="file" id="screenshot" accept="image/*" required>
			</div>
			<div class="error" id="utr-error"></div>
			<button id="utr-validate">Validate UTR</button>
			<div id="utr-emoji" style="display:none; font-size:42px; text-align:center; margin-top:8px;">ðŸ˜ </div>
			<div class="success" id="utr-loading" style="display:none; text-align:center;">Processing, please wait...</div>
			<!-- success line and proceed button removed as per request -->
		</div>

		<form id="registration-form" class="hidden" enctype="multipart/form-data">
			<div class="form-group">
				<label for="name">Name</label>
				<input type="text" id="name" name="name" required>
			</div>
			<div class="form-group">
				<label for="regno">Registration Number</label>
				<input type="text" id="regno" name="regno" required pattern="^\d{5,}$" inputmode="numeric" placeholder="Enter registration number (min 5 digits)" title="Enter at least 5 digits (numbers only)">
				<div class="error" id="regno-error"></div>
			</div>
			<div class="form-group">
				<label for="course">Course</label>
				<select id="course" name="course" required>
					<option value="">Select Course</option>
					<option value="B.Tech">B.Tech</option>
					<option value="DEGREE">DEGREE</option>
					<option value="Other">Other</option>
				</select>
			</div>
			<div class="form-group" id="branch-btech-group" style="display:none;">
				<label for="branch-btech">Choose Branch</label>
				<select id="branch-btech" name="branch-btech">
					<option value="">Select Branch</option>
					<option value="CSE">CSE</option>
					<option value="CSE(AI&ML)">CSE(AI&ML)</option>
					<option value="CIVIL">CIVIL</option>
					<option value="MECHANICAL">MECHANICAL</option>
				</select>
			</div>
			<div class="form-group" id="degree-type-group" style="display:none;">
				<label for="degree-type">Degree Type</label>
				<select id="degree-type" name="degree-type">
					<option value="">Select Degree Type</option>
					<option value="BCA">BCA</option>
					<option value="BSC (all groups)">BSC (all groups)</option>
					<option value="BBA">BBA</option>
					<option value="OTHERS">OTHERS</option>
				</select>
			</div>
			<div class="form-group" id="degree-other-group" style="display:none;">
				<label for="degree-other">Enter Group (for OTHERS)</label>
				<input type="text" id="degree-other" name="degree-other" placeholder="Enter your group">
			</div>
			<div class="form-group" id="branch-group" style="display:none;">
				<label for="branch">Branch (for Other only)</label>
				<input type="text" id="branch" name="branch">
			</div>
			<div class="form-group">
				<label for="year">Year</label>
				<select id="year" name="year" required>
					<option value="">Select Year</option>
					<option value="1">1</option>
					<option value="2">2</option>
					<option value="3">3</option>
					<option value="4">4</option>
				</select>
			</div>
			<div class="form-group" id="section-group" style="display:none;">
				<label for="section">Section</label>
				<select id="section" name="section">
					<option value="">Select Section</option>
				</select>
			</div>
			<div class="form-group">
				<label for="campus">Campus</label>
				<select id="campus" name="campus" required>
					<option value="">Select Campus</option>
					<option value="RUSHIKONDA">RUSHIKONDA</option>
					<option value="MVP">MVP</option>
					<option value="DWARAKANAGAR">DWARAKANAGAR</option>
				</select>
			</div>
			<input type="hidden" id="utr-hidden" name="utr">
			<input type="hidden" id="screenshot-hidden" name="screenshot">
			<div class="error" id="form-submit-error"></div>
			<button type="submit" id="submit-btn">Submit</button>
		</form>
	</div>

	<!-- Footer mini contact button (tap-to-call) -->
	<a class="mini-contact-btn" id="miniContactFooter" href="tel:+918374466616">Contact for payment issues</a>

	<script>
		// Fee display logic (self-contained)
		(function(){
			const courseFees = {
				'B.Tech': { '1': 100, '2': 200, '3': 300, '4': 400 },
				'DEGREE': { '1': 100, '2': 200, '3': 300 },
				'Other':  { '1': 100, '2': 200, '3': 300 }
			};
			let upiConfig = { pa: '', pn: 'SHREST MAHOTSAV' };
			const courseSel = document.getElementById('feeCourseSelect');
			const otherCourseGroup = document.getElementById('feeOtherCourseGroup');
			const courseOther = document.getElementById('feeCourseOther');
			const yearSel = document.getElementById('feeYearSelect');
			const yearBlock = document.getElementById('feeYearBlock');
			const feeEl = document.getElementById('feeDisplayReg');
			const phonepeAmount = document.getElementById('feePhonepeAmount');
			const upiCanvas = document.getElementById('upiQrCanvas');
			const upiWarn = document.getElementById('feeUpiWarn');

			async function fetchUpiConfig() {
				try {
					if (location.protocol === 'file:') {
						upiWarn.style.display = 'block';
						upiWarn.textContent = 'Open this page via a web server (http/https), not file://, for QR to work.';
						return;
					}
					const resp = await fetch('/api/upi-config');
					const data = await resp.json();
					upiConfig = { pa: data.pa || '', pn: data.pn || 'SHREST MAHOTSAV' };
					updateFee();
				} catch (e) {
					upiWarn.style.display = 'block';
					upiWarn.textContent = 'Could not load UPI details. Ensure server is running.';
				}
			}

			async function renderUpi(fee) {
				const course = courseSel.value;
				const yr = yearSel.value;
				const tn = `SHREST fee ${course} Y${yr}`;
				if (upiConfig.pa && fee > 0) {
					try {
						upiWarn.style.display = 'none';
						const qUrl = `/api/upi-qr?am=${encodeURIComponent(fee)}&tn=${encodeURIComponent(tn)}`;
						const img = new Image();
						img.onload = () => {
							const ctx = upiCanvas.getContext('2d');
							upiCanvas.width = Math.min(300, img.width);
							upiCanvas.height = upiCanvas.width;
							ctx.clearRect(0,0,upiCanvas.width, upiCanvas.height);
							ctx.drawImage(img, 0, 0, upiCanvas.width, upiCanvas.height);
						};
						img.onerror = () => {
							upiWarn.style.display = 'block';
							upiWarn.textContent = 'Failed to load QR image. Ensure server is running.';
						};
						img.src = qUrl;
					} catch (e) {
						upiWarn.style.display = 'block';
						upiWarn.textContent = 'Failed to render QR.';
					}
				} else {
					if (upiCanvas) { const ctx = upiCanvas.getContext('2d'); ctx && ctx.clearRect(0,0,upiCanvas.width, upiCanvas.height); }
				}
			}
			
			const utrInput = document.getElementById('utr');
			const screenshotInput = document.getElementById('screenshot');
			const utrBtn = document.getElementById('utr-validate');
			const applyGate = () => {
				const hasCourse = courseSel.value && courseSel.value !== 'select';
				const hasYear = !!yearSel.value;
				const enabled = hasCourse && hasYear;
				[utrInput, screenshotInput, utrBtn].forEach(el => { if (el) el.disabled = !enabled; });
			};

			const setYearOptions = (maxYear) => {
				const current = yearSel.value;
				const opts = [
					'<option value="">Select your year</option>',
					'<option value="1">1st Year</option>',
					'<option value="2">2nd Year</option>',
					'<option value="3">3rd Year</option>'
				];
				if (maxYear >= 4) opts.push('<option value="4">4th Year</option>');
				yearSel.innerHTML = opts.join('');
				if (current && Number(current) <= maxYear) {
					yearSel.value = current;
				} else {
					yearSel.value = '';
				}
				applyGate();
			};

			const updateCourseUI = () => {
				const isBTech = courseSel.value === 'B.Tech';
				otherCourseGroup.style.display = courseSel.value === 'Other' ? 'block' : 'none';
				const hasCourse = courseSel.value && courseSel.value !== 'select';
				yearBlock.style.display = hasCourse ? 'block' : 'none';
				setYearOptions(isBTech ? 4 : 3);
				if (!isBTech && yearSel.value === '4') yearSel.value = '';
				applyGate();
			};

			const updateFee = () => {
				const course = courseSel.value;
				const yr = yearSel.value;
				const table = courseFees[course] || {};
				const fee = yr ? (table[yr] || 0) : 0;
				if (course && course !== 'select' && yr && fee > 0) {
					feeEl.textContent = `Fee: Rs ${fee}`;
					if (phonepeAmount) phonepeAmount.textContent = upiConfig.pa ? `Pay Rs ${fee} to this account` : `UPI account not configured`;
					renderUpi(fee);
				} else {
					feeEl.textContent = 'Fee: -';
					if (phonepeAmount) phonepeAmount.textContent = (course && course !== 'select') ? 'Select year to see amount' : 'Select course to see amount';
					renderUpi(0);
				}
				try {
					if (course && course !== 'select') localStorage.setItem('shrest.course', String(course));
					if (courseSel.value === 'Other') localStorage.setItem('shrest.courseName', String((courseOther.value || '').trim()));
					else localStorage.removeItem('shrest.courseName');
					if (yr) localStorage.setItem('shrest.year', String(yr));
					else localStorage.removeItem('shrest.year');
					localStorage.setItem('shrest.fee', String(fee));
				} catch (_) {}
				applyGate();
			};

			courseSel.addEventListener('change', () => { updateCourseUI(); yearSel.value=''; updateFee(); });
			courseOther.addEventListener('input', updateFee);
			yearSel.addEventListener('change', updateFee);
			
			// Initial setup
			fetchUpiConfig();
			updateCourseUI();
			updateFee();
		})();

		// --- NEW SIMPLIFIED LOGIC ---

		// 1. UTR Validation Step
		document.getElementById('utr-validate').onclick = async function() {
			const utr = document.getElementById('utr').value.trim();
			const screenshot = document.getElementById('screenshot').files[0];
			const errorDiv = document.getElementById('utr-error');
			const loadingDiv = document.getElementById('utr-loading');
			const validateBtn = this;

			errorDiv.textContent = '';
			
			if (!/^\d{12}$/.test(utr)) {
				errorDiv.textContent = 'Enter a valid 12-digit UTR number.';
				return;
			}
			if (!screenshot) {
				errorDiv.textContent = 'Please upload the payment screenshot.';
				return;
			}

			loadingDiv.style.display = 'block';
			validateBtn.disabled = true;

			try {
				const response = await fetch('/api/validate-utr', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ utr: utr })
				});

				const data = await response.json();

				if (!response.ok || !data.valid) {
					throw new Error(data.message || 'Invalid UTR number.');
				}
				if (data.duplicate) {
					throw new Error('This UTR has already been used.');
				}

				// UTR is valid, proceed to show the form
				document.getElementById('utr-section').classList.add('hidden');
				document.getElementById('registration-form').classList.remove('hidden');
				document.getElementById('utr-hidden').value = utr;

				// Store screenshot in localStorage to pass to the next step
				const reader = new FileReader();
				reader.onloadend = function() {
					try {
						localStorage.setItem('shrest.screenshot', reader.result);
					} catch (e) {
						console.error("Could not save screenshot to localStorage", e);
						errorDiv.textContent = "Could not process screenshot. It might be too large. Please refresh and try again.";
					}
				};
				reader.readAsDataURL(screenshot);

			} catch (error) {
				errorDiv.textContent = error.message;
			} finally {
				loadingDiv.style.display = 'none';
				validateBtn.disabled = false;
			}
		};

		// 2. Registration Form Submission Step
		document.getElementById('registration-form').onsubmit = async function(event) {
			event.preventDefault();
			
			const submitBtn = document.getElementById('submit-btn');
			const errorDiv = document.getElementById('form-submit-error');
			const form = this;

			submitBtn.disabled = true;
			submitBtn.textContent = 'Submitting...';
			errorDiv.textContent = '';

			const utr = document.getElementById('utr-hidden').value;

			try {
				// Final check for UTR duplication before registering to prevent race conditions
				const utrValidationResponse = await fetch('/api/validate-utr', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ utr: utr })
				});
				const utrValidationData = await utrValidationResponse.json();
				if (utrValidationData.duplicate) {
					throw new Error('This UTR number was just registered by someone else. Please use a new payment.');
				}

				const formData = new FormData(form);
				const screenshotDataUrl = localStorage.getItem('shrest.screenshot');
				
				if (!screenshotDataUrl) {
					throw new Error('Screenshot data not found. Please go back and re-upload.');
				}
				// The screenshot is sent as a data URL string, not a file upload
				formData.append('screenshotDataUrl', screenshotDataUrl);
				// We no longer need the file input data
				formData.delete('screenshot');

				const registrationResponse = await fetch('/api/register', {
					method: 'POST',
					body: formData
				});

				if (!registrationResponse.ok) {
					const errorData = await registrationResponse.json().catch(() => ({ message: 'An unknown server error occurred.' }));
					throw new Error(errorData.message);
				}
				
				const registrationData = await registrationResponse.json();

				if (registrationData.success) {
					// Store registration details for the next page
					localStorage.setItem('shrest.regno', formData.get('regno'));
					localStorage.setItem('shrest.name', formData.get('name'));
					
					// Clean up storage
					localStorage.removeItem('shrest.screenshot');
					
					console.log('Registration successful, redirecting to events.html');
					window.location.href = 'events.html';
				} else {
					throw new Error(registrationData.message || 'Registration failed. Please try again.');
				}

			} catch (error) {
				errorDiv.textContent = error.message;
				submitBtn.disabled = false;
				submitBtn.textContent = 'Submit';
			}
		};

		// 3. Dynamic Form Fields Logic (for course, branch, etc.)
		(function() {
			const courseSelect = document.getElementById('course');
			const btechBranchGroup = document.getElementById('branch-btech-group');
			const degreeTypeGroup = document.getElementById('degree-type-group');
			const degreeOtherGroup = document.getElementById('degree-other-group');
			const branchGroup = document.getElementById('branch-group');
			const yearSelect = document.getElementById('year');
			const sectionGroup = document.getElementById('section-group');
			const sectionSelect = document.getElementById('section');
			const degreeTypeSelect = document.getElementById('degree-type');

			const sectionsByYear = {
				'1': ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'],
				'2': ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'],
				'3': ['A', 'B', 'C', 'D', 'E', 'F'],
				'4': ['A', 'B', 'C', 'D']
			};

			function updateFormFields() {
				const course = courseSelect.value;
				const year = yearSelect.value;

				btechBranchGroup.style.display = 'none';
				degreeTypeGroup.style.display = 'none';
				degreeOtherGroup.style.display = 'none';
				branchGroup.style.display = 'none';
				sectionGroup.style.display = 'none';

				if (course === 'B.Tech') {
					btechBranchGroup.style.display = 'block';
					sectionGroup.style.display = 'block';
				} else if (course === 'DEGREE') {
					degreeTypeGroup.style.display = 'block';
					if (degreeTypeSelect.value === 'OTHERS') {
						degreeOtherGroup.style.display = 'block';
					}
				} else if (course === 'Other') {
					branchGroup.style.display = 'block';
				}

				if (course === 'B.Tech' && year && sectionsByYear[year]) {
					sectionSelect.innerHTML = '<option value="">Select Section</option>' +
						sectionsByYear[year].map(s => `<option value="${s}">${s}</option>`).join('');
				} else {
					sectionSelect.innerHTML = '<option value="">Select Section</option>';
				}
			}
			
			degreeTypeSelect.addEventListener('change', updateFormFields);
			courseSelect.addEventListener('change', updateFormFields);
			yearSelect.addEventListener('change', updateFormFields);
			
			updateFormFields();
		})();
	</script>
</body>
</html>
